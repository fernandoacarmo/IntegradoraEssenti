CREATE OR REPLACE VIEW ESVVTEXESTOQUE
AS
SELECT PCEST.CODFILIAL
     , PCEST.CODPROD     
     , PCFILIAL.VTEXWAREHOUSE
     , GREATEST(CASE WHEN PCPRODUT.DTEXCLUSAO IS NOT NULL
                     THEN 0
                     WHEN NVL(PCPRODUT.OBS2,'X') = 'PV'
                     THEN 0
                     WHEN GREATEST(TRUNC((NVL(PCEST.QTESTGER,0) - NVL(PCEST.QTRESERV,0) - NVL(PCEST.QTBLOQUEADA,0)) * 0.8),0) <= 1 
                     THEN 0
                     WHEN GREATEST(TRUNC((NVL(PCEST.QTESTGER,0) - NVL(PCEST.QTRESERV,0) - NVL(PCEST.QTBLOQUEADA,0)) * 0.8),0) BETWEEN 2 AND 10
                     THEN 1                     
                     ELSE GREATEST(TRUNC((NVL(PCEST.QTESTGER,0) - NVL(PCEST.QTRESERV,0) - NVL(PCEST.QTBLOQUEADA,0)) * 0.8),0)
                END,0) QTESTOQUE
     , SYSDATE DTULTIMOBALANCO
  FROM PCFILIAL
     , PCEST
     , PCPRODUT
 WHERE PCFILIAL.CODIGO = PCEST.CODFILIAL
   AND PCFILIAL.CODIGO NOT IN ('99')
   AND PCFILIAL.VTEXWAREHOUSE IS NOT NULL
   AND PCEST.CODPROD = PCPRODUT.CODPROD
   
   